<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="icon"
      type="image/png"
      href="https://i.pinimg.com/originals/2c/a6/47/2ca6474064c8d4f895a596ad55ba7226.webp"
    />
    <title>YouTube Video Keeper</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f0f2f5;
        color: #333;
        padding-top: 30px;
        margin: 0 20px;
      }
      .container {
        max-width: 900px;
        margin: 0 auto;
        padding-bottom: 20px;
      }
      .inputer {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
        width: 100%;
      }
      input[type="text"] {
        flex-grow: 1;
        font-size: 18px;
        padding: 12px 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      button {
        font-size: 16px;
        padding: 12px 20px;
        text-transform: uppercase;
        letter-spacing: 2px;
        font-weight: bold;
        color: #fff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition:
          background-color 0.2s,
          box-shadow 0.2s;
      }
      .submit-btn {
        background: #c00;
      }
      .submit-btn:hover {
        background: #a00;
      }
      .submit-btn:active {
        background: #800;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
      }
      .shower {
        margin-top: 20px;
        text-align: center;
        margin-bottom: 40px;
        background: #000;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        min-height: 470px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .shower iframe {
        display: block;
        max-width: 100%;
        border-radius: 5px;
      }
      hr {
        border: none;
        border-top: 1px solid #ddd;
        margin: 40px 0;
      }

      /* NEW: Flex header for title and actions */
      .list-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid #c00;
        padding-bottom: 10px;
        margin-bottom: 20px;
      }
      .list-header h2 {
        margin: 0;
        border-bottom: none;
        padding-bottom: 0;
      }
      .action-buttons {
        display: flex;
        gap: 10px;
      }
      .btn-secondary {
        color: #fff;
        font-size: 12px;
        padding: 8px 15px;
        text-transform: uppercase;
        opacity: 0.8;
      }
      .btn-secondary:hover {
        opacity: 1;
      }
      .export-btn {
        background: #266601;
      }
      .import-btn {
        background: #720303;
      }

      .videoList {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
        gap: 20px;
      }
      .video-item {
        position: relative;
        background: #fff;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition:
          transform 0.2s,
          box-shadow 0.2s;
      }
      .video-item:hover {
        transform: scale(1.03);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }
      .video-item img {
        width: 100%;
        height: auto;
        display: block;
        border: none;
        border-radius: 5px;
      }
      .video-item .remove {
        position: absolute;
        top: 5px;
        right: 5px;
        width: 28px;
        height: 28px;
        padding: 0;
        font-size: 14px;
        font-weight: bold;
        line-height: 28px;
        text-align: center;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        opacity: 0.5;
        transition:
          opacity 0.2s,
          background-color 0.2s;
        z-index: 10;
      }
      .video-item .remove:hover {
        background-color: #c00;
      }
      .video-item:hover .remove {
        opacity: 1;
      }
      @media screen and (max-width: 650px) {
        .shower {
          min-height: 180px;
        }
        button {
          font-size: 12px;
          padding: 12px 15px;
        }
        input[type="text"] {
          font-size: 12px;
        }
        .v-controller {
          height: 200px !important;
        }
        .inputer {
          margin-top: 20px;
        }
        .list-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="inputer">
        <input
          type="text"
          placeholder="Paste a YouTube URL here..."
          id="urlInput"
          autocomplete="off"
        />
        <button id="submitBtn" class="submit-btn">Save</button>
      </div>

      <div id="mainPlayer" class="shower">
        <p style="color: #777">Saved videos will be played here.</p>
      </div>
      <hr />

      <!-- MODIFIED: Header with actions -->
      <div class="list-header">
        <h2>Saved Videos (<span id="videoCount">0</span>)</h2>
        <div class="action-buttons">
          <button id="exportBtn" class="btn-secondary export-btn">
            Export Backup
          </button>
          <button id="importBtn" class="btn-secondary import-btn">
            Import Backup
          </button>
          <!-- Hidden file input for import -->
          <input
            type="file"
            id="importInput"
            accept=".json"
            style="display: none"
          />
        </div>
      </div>

      <div id="videoList" class="videoList">
        <!-- The list of saved video thumbnails will go here -->
      </div>
    </div>

    <script>
      /**
       * YouTube Video Keeper - Refactored for performance and state management.
       */

      // --- DOM Elements ---
      const urlInput = document.getElementById("urlInput");
      const submitBtn = document.getElementById("submitBtn");
      const mainPlayer = document.getElementById("mainPlayer");
      const videoList = document.getElementById("videoList");
      const videoCount = document.getElementById("videoCount");
      const exportBtn = document.getElementById("exportBtn");
      const importBtn = document.getElementById("importBtn");
      const importInput = document.getElementById("importInput");

      // --- State ---
      let videoKeeper = [];
      let currentVideoId = localStorage.getItem("lastVideoId") || null;

      // --- Utility Functions ---

      function getVideoId(url) {
        const regExp =
          /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
        const match = url.match(regExp);
        return match && match[2].length === 11 ? match[2] : null;
      }

      function saveVideos() {
        localStorage.setItem("videoKeeper", JSON.stringify(videoKeeper));
      }

      function highlightActiveThumbnail(videoId) {
        const items = videoList.querySelectorAll(".video-item");
        items.forEach((item) => {
          if (item.dataset.id === videoId) {
            item.style.boxShadow = "0 0 0 4px red";
          } else {
            item.style.boxShadow = "none";
          }
        });
      }

      function renderSavedVideos() {
        videoList.innerHTML = "";
        videoCount.textContent = videoKeeper.length;

        videoKeeper.forEach((videoId) => {
          const videoItem = document.createElement("div");
          videoItem.className = "video-item";
          videoItem.dataset.id = videoId;

          if (videoId === currentVideoId) {
            videoItem.style.boxShadow = "0 0 0 4px red";
          }

          videoItem.innerHTML = `
      <img src="https://img.youtube.com/vi/${videoId}/mqdefault.jpg" alt="Video thumbnail" loading="lazy">
      <button class="remove" data-id="${videoId}">X</button>
    `;
          videoList.appendChild(videoItem);
        });
      }

      function updateMainPlayer(videoId) {
        currentVideoId = videoId;

        if (!videoId) {
          mainPlayer.innerHTML =
            '<p style="color: #777;">Saved videos will be played here.</p>';
          localStorage.removeItem("lastVideoId");
          return;
        }

        const embedHtml = `
    <iframe 
      src="https://www.youtube.com/embed/${videoId}?autoplay=0" 
      frameborder="0" 
      width="700" 
      height="450" 
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
      allowfullscreen 
      class="v-controller">
    </iframe>`;

        mainPlayer.innerHTML = embedHtml;
        localStorage.setItem("lastVideoId", videoId);
        highlightActiveThumbnail(videoId);
      }

      function handleAddVideo() {
        const url = urlInput.value.trim();
        if (!url) return alert("Please enter a YouTube URL.");

        const videoId = getVideoId(url);
        if (!videoId) return alert("Invalid YouTube URL.");

        if (videoKeeper.includes(videoId)) {
          updateMainPlayer(videoId);
          urlInput.value = "";
          return;
        }

        videoKeeper.unshift(videoId);
        saveVideos();
        renderSavedVideos();
        updateMainPlayer(videoId);
        urlInput.value = "";
      }

      // --- NEW: Export/Import Logic ---

      function handleExport() {
        if (videoKeeper.length === 0) {
          return alert("No videos to export.");
        }

        const now = new Date();
        // Format: YYYY-MM-DD_HH-mm-ss
        const datePart = now.toISOString().split("T")[0];
        const timePart = now.toTimeString().split(" ")[0].replace(/:/g, "-");
        const fileName = `yt-video-keeper-backup-${datePart}_${timePart}.json`;

        const dataStr = JSON.stringify(videoKeeper, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function handleImportClick() {
        importInput.click();
      }

      function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const importedData = JSON.parse(e.target.result);
            if (Array.isArray(importedData)) {
              // Merge strategy: Add only IDs that don't exist yet
              const newIds = importedData.filter(
                (id) => !videoKeeper.includes(id),
              );

              if (newIds.length === 0) {
                alert("No new videos found in this backup.");
              } else {
                videoKeeper = [...newIds, ...videoKeeper];
                saveVideos();
                renderSavedVideos();
                alert(`Successfully imported ${newIds.length} videos.`);
              }
            } else {
              alert(
                "Invalid backup file. content must be a list of video IDs.",
              );
            }
          } catch (err) {
            console.error(err);
            alert("Error parsing the backup file.");
          }
          // Reset the input so the same file can be selected again if needed
          importInput.value = "";
        };
        reader.readAsText(file);
      }

      // --- Initialization ---
      function initialize() {
        const savedVideos = localStorage.getItem("videoKeeper");
        if (savedVideos) {
          videoKeeper = JSON.parse(savedVideos);
        }

        renderSavedVideos();

        if (currentVideoId) {
          updateMainPlayer(currentVideoId);
        }
      }

      // --- Event Listeners ---

      submitBtn.addEventListener("click", handleAddVideo);

      urlInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") handleAddVideo();
      });

      // NEW: Export/Import Listeners
      exportBtn.addEventListener("click", handleExport);
      importBtn.addEventListener("click", handleImportClick);
      importInput.addEventListener("change", handleFileSelect);

      videoList.addEventListener("click", (e) => {
        const removeButton = e.target.closest(".remove");
        const videoItem = e.target.closest(".video-item");

        if (removeButton) {
          e.stopPropagation();
          const idToRemove = removeButton.dataset.id;
          videoKeeper = videoKeeper.filter((id) => id !== idToRemove);
          saveVideos();

          if (idToRemove === currentVideoId) {
            updateMainPlayer(videoKeeper[0] || null);
          }
          renderSavedVideos();
          return;
        }

        if (videoItem) {
          const idToPlay = videoItem.dataset.id;
          if (idToPlay !== currentVideoId) {
            updateMainPlayer(idToPlay);
            window.scrollTo({ top: 0, behavior: "smooth" });
          }
        }
      });

      // --- Run ---
      initialize();
    </script>
  </body>
</html>
